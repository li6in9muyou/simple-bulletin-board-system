<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>公共留言板</title>
    <style>
      input[type="select"] {
        font-size: 10rem;
      }
      #personal-info > div {
        display: flex;
        padding: 2px;
        align-items: center;
      }
      label {
        user-select: none;
      }
      #personal-info > div > label {
        min-width: 25%;
      }
      #personal-info > * {
        padding: 0;
        margin: 0 0 0.5rem;
      }
      #personal-info {
        font-family: FangSong, serif;
        background-color: lightyellow;
        max-width: 60%;
        margin: auto;
      }
      #form-caption {
        background-color: lightgray;
        text-align: center;
        margin-bottom: 0;
      }
      #skills {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      #department {
        padding: 2px;
      }
    </style>
    <style>
      #secondAssignmentTimetable {
        background-color: lightyellow;
        padding: 8px;
        margin: auto;
      }
      .second-CourseTable {
        margin: auto;
        border: black 2px solid;
        border-radius: 1rem;
        padding: 12px;
      }
      .second-CourseTable--TimeAside {
        max-width: 50px;
        padding: 2px;
      }
      .second-CourseTable--Cell {
        padding: 6px;
        height: 2rem;
        box-shadow: 2px 2px 1px gray;
        cursor: pointer;
      }
      .popup {
        display: none;
        position: absolute;
        padding: 5px;
        z-index: 999;
        top: 0;
        left: 0;
        width: 200px;
        background-color: antiquewhite;
      }
    </style>
    <style>
      #secondAssignmentUserInputValidation {
        background-color: lightyellow;
        padding: 8px;
        margin-top: 2rem;
      }
      .second-UserInput {
        padding: 10px;
        display: flex;
      }
      .second-UserInput--Form {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 10px;
      }
    </style>
    <style>
      #secondAssignmentUserCheckOutPage {
        background-color: lightyellow;
        padding: 8px;
        margin-top: 2rem;
      }
      .second-CheckOutPage {
        padding: 10px;
        display: flex;
        flex-direction: column;
        width: fit-content;
      }
      .second-CheckOutPageContainer {
        display: flex;
      }
    </style>
    <style>
      .third-ace-editor {
        height: 500px;
      }
    </style>
    <style>
      .fourth-ace-editor {
        height: 500px;
      }
    </style>
    <style>
      #fifth-student-score-display {
        font-size: 40px;
      }
      #fifth-student-name-select {
        font-size: 2rem;
        padding: 10px;
      }
    </style>
    <style>
      #ssg-comment-section {
        outline: black 1px solid;
        padding: 8px;
      }
    </style>
  </head>
  <body>
    <section id="staticSiteGenerator">
      <h1>公共留言板</h1>
      <section id="ssg-comment-section">
        <h1>评论区</h1>
        <ol data-ssg-comments-list></ol>
        <label for="ssg-nickname">网名</label>
        <input
          type="text"
          id="ssg-nickname"
          required
          minlength="1"
          maxlength="20"
          data-ssg-comment-nickname
        />
        <label for="ssg-challenge">身份认证密码（可不填）</label>
        <input
          type="password"
          id="ssg-challenge"
          minlength="1"
          maxlength="20"
          pattern="[0-9a-z]+"
          data-ssg-challenge
        />
        <label for="ssg-comment">留言</label>
        <textarea
          id="ssg-comment"
          data-ssg-comment-text
          minlength="1"
          maxlength="200"
          required
        ></textarea>
        <button data-ssg-comment-send>发送</button>
        <script>
          function addCommentToView(comment) {
            const domCommentsList = document.querySelector(
              "[data-ssg-comments-list]"
            );
            function addCommentToViewHelper(nickname, text, ...remarks) {
              const comment = document.createElement("li");
              comment.innerText = `“${nickname}”说：${text}`;
              remarks = remarks.filter((x) => Boolean(x));
              if (remarks.length > 0) {
                comment.innerText += `（备注：${remarks.join("，")}）`;
              }
              domCommentsList.appendChild(comment);
            }
            function isAdmin(comment) {
              return (
                comment.isVerified !== "" &&
                comment.expand.isVerified.isVerified
              );
            }
            addCommentToViewHelper(
              comment.nickname,
              comment.text,
              isAdmin(comment) ? "发言者身份已认证" : "",
              `发表于${new Date(comment.created).toLocaleString()}`
            );
          }
          const domCommentVerificationChallenge = document.querySelector(
            "[data-ssg-challenge]"
          );
          const domCommentNickname = document.querySelector(
            "[data-ssg-comment-nickname]"
          );
          const domCommentText = document.querySelector(
            "[data-ssg-comment-text]"
          );
          function inputNickname() {
            return domCommentNickname.value;
          }
          function inputText() {
            return domCommentText.value;
          }
          function verificationChallenge() {
            return domCommentVerificationChallenge.value;
          }
          function clearInput() {
            domCommentNickname.value = "";
            domCommentText.value = "";
          }
        </script>
        <script type="module">
          import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.10/dist/pocketbase.es.mjs";
          const pb = new PocketBase("https://stocky-candle.pockethost.io");
          const commentsModel = pb.collection("comments");
          commentsModel.subscribe("*", (e) => {
            const comment = e.record;
            pb.collection("is_comment_verified")
              .getOne(comment.isVerified)
              .then((token) => {
                comment.expand.isVerified = token;
                addCommentToView(comment);
              });
          });
          (
            await commentsModel.getList(1, 20, { expand: "isVerified" })
          ).items.map(addCommentToView);
          const domCommentSend = document.querySelector(
            "[data-ssg-comment-send]"
          );

          function createUnverifiedComment() {
            pb.collection("is_comment_verified")
              .create({
                isVerified: false,
              })
              .then((token) => {
                commentsModel.create({
                  nickname: inputNickname(),
                  text: inputText(),
                  isVerified: token.id,
                });
              })
              .catch(createUnverifiedComment);
          }

          function createVerifiedComment() {
            pb.collection("is_comment_verified")
              .create({
                challenge: verificationChallenge(),
                isVerified: true,
              })
              .then((token) => {
                commentsModel.create({
                  nickname: inputNickname(),
                  text: inputText(),
                  isVerified: token.id,
                });
              })
              .catch(createUnverifiedComment);
          }

          domCommentSend.addEventListener("click", () => {
            domCommentSend.disabled = true;
            try {
              if (verificationChallenge() === "") {
                createUnverifiedComment();
              } else {
                createVerifiedComment();
              }
            } catch (e) {
              console.warn("not implemented");
              console.warn(e);
            } finally {
              domCommentSend.disabled = false;
            }
          });
        </script>
      </section>
    </section>
  </body>
</html>
